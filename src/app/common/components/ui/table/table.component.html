<!-- table.component.html -->
<div class="w-full">
  <div class="overflow-x-auto rounded-2xl border border-border-subtle bg-surface-raised">
    <table class="min-w-full border-separate border-spacing-0">
      <thead class="bg-surface-subtle">
        <tr>
          @for (col of columns(); track col) {
            <th
              class="sticky top-0 z-10 border-b border-border-subtle px-4 py-3 text-xs font-semibold uppercase tracking-wide text-content-secondary"
              [ngClass]="[
                col.headerClass ?? '',
                col.widthClass ?? '',
                getAlignClass(col.align),
              ]"
            >
              {{ col.header }}
            </th>
          }
        </tr>
      </thead>

      <tbody>
        <!-- Loading -->
        @if (isLoading()) {
          @for (_ of [1, 2, 3, 4, 5]; track _) {
            <tr>
              @for (col of columns(); track col) {
                <td class="border-b border-border-subtle px-4 py-3">
                  <div
                    class="h-4 w-full animate-pulse rounded bg-surface-subtle"
                  ></div>
                </td>
              }
            </tr>
          }
        } @else if (error()) {
          <tr>
            <td [attr.colspan]="colCount()" class="px-4 py-20 text-center">
              <div class="flex flex-col items-center justify-center gap-2">
                <span class="text-3xl">‚ö†Ô∏è</span>
                <p class="text-sm font-semibold text-danger">
                  Error al cargar los datos
                </p>
                <p class="text-xs text-content-muted">
                  Por favor, intenta refrescar la p√°gina
                </p>
              </div>
            </td>
          </tr>
        } @else {
          <!-- Empty -->
          @if (!data().length) {
            <tr>
              <td
                [attr.colspan]="colCount()"
                class="px-4 py-10 text-center text-sm text-content-secondary"
              >
                No hay datos para mostrar ü´†
              </td>
            </tr>
          }
          <!-- Rows -->
          @for (row of data(); track trackBy()($index, row)) {
            <tr
              class="cursor-pointer hover:bg-surface-subtle"
              (click)="rowClick.emit(row)"
            >
              @for (col of columns(); track col) {
                <td
                  class="border-b border-border-subtle px-4 py-3 text-sm text-content-primary"
                  [ngClass]="[
                    col.cellClass ?? '',
                    col.widthClass ?? '',
                    getAlignClass(col.align),
                  ]"
                >
                  @if (!col.actions) {
                    @switch (col.pipe) {
                      @case ("date") {
                        {{
                          getCellValue(row, col)
                            | date: col.pipeArgs || "dd/MM/yyyy"
                        }}
                      }
                      @case ("currency") {
                        {{
                          getCellValue(row, col)
                            | currency: col.pipeArgs || "CLP"
                        }}
                      }
                      @default {
                        {{ getCellValue(row, col) }}
                      }
                    }
                  } @else {
                    <div
                      class="flex items-center gap-2 justify-center"
                      [ngClass]="getAlignClass(col.align)"
                    >
                      @for (action of col.actions; track action) {
                        @if (!action.show || action.show(row)) {
                          <button
                            type="button"
                            (click)="
                              $event.stopPropagation(); action.callback(row)
                            "
                            class="inline-flex items-center rounded-lg p-1.5 transition-colors z-10 cursor-pointer"
                            [ngClass]="
                              action.class ||
                              'text-content-muted hover:bg-surface-subtle hover:text-content-secondary'
                            "
                            [title]="action.label"
                          >
                            @if (action.icon) {
                              <i [class]="action.icon" class="text-lg">{{
                                action.label
                              }}</i>
                            }
                            @if (!action.icon) {
                              <span>{{ action.label }}</span>
                            }
                          </button>
                        }
                      }
                    </div>
                  }
                </td>
              }
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  @if (pagination()) {
    <div
      class="flex items-center justify-between border-t border-border-subtle bg-surface-raised px-4 py-3 sm:px-6 mt-4 rounded-xl shadow-sm"
    >
      <div class="flex flex-1 justify-between sm:hidden">
        <button
          (click)="pageChange.emit(pagination()!.currentPage - 1)"
          [disabled]="!canGoPrevious()"
          class="relative inline-flex items-center rounded-md border border-border bg-surface-raised px-4 py-2 text-sm font-medium text-content-primary hover:bg-surface-subtle disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Anterior
        </button>
        <button
          (click)="pageChange.emit(pagination()!.currentPage + 1)"
          [disabled]="!canGoNext()"
          class="relative ml-3 inline-flex items-center rounded-md border border-border bg-surface-raised px-4 py-2 text-sm font-medium text-content-primary hover:bg-surface-subtle disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Siguiente
        </button>
      </div>
      <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-content-primary">
            Mostrando
            <span class="font-medium">{{ showingFrom() }}</span>
            a
            <span class="font-medium">{{ showingTo() }}</span>
            de
            <span class="font-medium">{{ pagination()?.totalItems }}</span>
            resultados
          </p>
        </div>
        <div>
          <nav
            class="isolate inline-flex -space-x-px rounded-md shadow-sm"
            aria-label="Pagination"
          >
            <button
              (click)="pageChange.emit(pagination()!.currentPage - 1)"
              [disabled]="!canGoPrevious()"
              class="relative inline-flex items-center rounded-l-md px-2 py-2 text-content-muted ring-1 ring-inset ring-border hover:bg-surface-subtle focus:z-20 focus:outline-offset-0 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
            >
              <span class="sr-only">Anterior</span>
              <lucide-icon [img]="ChevronLeft" class="w-5 h-5"></lucide-icon>
            </button>
            <div
              class="flex items-center px-4 py-2 text-sm font-semibold text-content-primary border-t border-b border-border ring-1 ring-inset ring-border"
            >
              P√°gina {{ pagination()?.currentPage }} de
              {{ pagination()?.totalPages }}
            </div>
            <button
              (click)="pageChange.emit(pagination()!.currentPage + 1)"
              [disabled]="!canGoNext()"
              class="relative inline-flex items-center rounded-r-md px-2 py-2 text-content-muted ring-1 ring-inset ring-border hover:bg-surface-subtle focus:z-20 focus:outline-offset-0 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
            >
              <span class="sr-only">Siguiente</span>
              <lucide-icon [img]="ChevronRight" class="w-5 h-5"></lucide-icon>
            </button>
          </nav>
        </div>
      </div>
    </div>
  }
</div>
